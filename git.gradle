/**
 *
 * This file is deprecated and subject to deletion. 
 * Please use version.gradle instead.
 *
 **/


ext.GIT = "git"

ext.getGitBranch = {
	def String rBranch
	if (project.hasProperty("branch")) {
		def branches = project.getProperty("branch").split('/')
		def branch =branches[branches.length-1]
		logger.info("-- Using parameter branch '$branch'")
		rBranch = branch
	} else {
		try {
			def stdout = new ByteArrayOutputStream()
			exec {
				executable = GIT
				args = [
					'rev-parse',
					'--abbrev-ref',
					'HEAD'
				]
				standardOutput = stdout
				errorOutput = new ByteArrayOutputStream()
			}
			def currentBranch = stdout.toString().trim()
			if (currentBranch.contains("release/")) {
				logger.info "-- Branch contains 'release'. Using 'candidate'".
				rBranch = "candidate"
			} else {
				def lastPath = currentBranch.split('/')
				rBranch = lastPath[lastPath.length-1]
				logger.info "-- Found branch '$rBranch' from 'git rev-parse --abbrev-ref HEAD'."
			}
		} catch(Exception e) {
			logger.info "-- Project is not in a git repository. Using 'local' (" + e.getMessage() + ")"
			return "local"
		}
	}
	if (rBranch.contains("release/")) {
		logger.info "-- Branch contains 'release'. Using 'RC'".
		return "RC"
	}
	if (rBranch.contains("master")) {
		logger.info "-- Branch contains 'master'. No branch name is used."
		return ""
	}
	
	return rBranch
}
/**
 * Version rule management.
 */
ext.branch = getGitBranch()
project.version = branch.isEmpty() ? version : (version + '.' + branch)

if (project.hasProperty("myVersion")) {
	def myVersion = project.getProperty("myVersion")
	logger.info "-- overide '$version' with $myVersion"
	version = myVersion;
}
if (version.startsWith("origin/")) {
	logger.info "-- removing 'origin/' from '$version'"
	version = version.substring(7);
}
version = version.replace("/","_");

logger.info "-- root project version = $version"
subprojects {
	project.version = rootProject.version
	logger.info "-- ${project.path} version = ${project.version}"
}


